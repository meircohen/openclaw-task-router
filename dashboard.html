<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<title>OpenClaw Router</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OpenClaw Router Dashboard v2
   Single-file, no framework, dark theme, iPhone-optimized
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

/* â”€â”€â”€ Custom Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  /* Backgrounds */
  --bg:#0a0a0f;
  --bg-s:#12121a;
  --bg-e:#1a1a26;
  --bg-o:#222233;
  /* Borders */
  --brd:#1e1e2e;
  --brd-h:#2a2a3e;
  --brd-f:#00ff88;
  /* Text */
  --t1:#e8e8f0;
  --t2:#6b6b80;
  --t3:#44445a;
  /* Status */
  --ok:#00ff88;
  --info:#3b82f6;
  --warn:#f59e0b;
  --err:#ef4444;
  /* Backend accents */
  --cc:#a855f7;
  --cx:#3b82f6;
  --api:#f59e0b;
  --loc:#10b981;
  /* Fonts */
  --sans:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  --mono:'JetBrains Mono','SF Mono','Fira Code',monospace;
  /* Sizing */
  --top-h:52px;
  --radius:8px;
  --radius-sm:5px;
}

/* â”€â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
html{font-size:14px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{
  font-family:var(--sans);background:var(--bg);color:var(--t1);
  line-height:1.5;min-height:100vh;min-height:100dvh;
  overflow-x:hidden;-webkit-font-smoothing:antialiased;
  padding-top:var(--top-h);
  padding-bottom:env(safe-area-inset-bottom,0);
}
::selection{background:rgba(0,255,136,.2);color:#fff}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--brd-h);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--t3)}

/* â”€â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
  position:fixed;top:0;left:0;right:0;z-index:200;
  height:var(--top-h);background:var(--bg-s);
  border-bottom:1px solid var(--brd);
  display:flex;align-items:center;
  padding:0 16px;gap:12px;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  padding-top:env(safe-area-inset-top,0);
}
.logo{
  font-family:var(--mono);font-size:.95rem;font-weight:700;
  color:var(--ok);letter-spacing:.5px;white-space:nowrap;
  display:flex;align-items:center;gap:6px;flex-shrink:0;
}
.logo svg{width:18px;height:18px;fill:var(--ok)}

/* â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav{
  display:flex;gap:1px;overflow-x:auto;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;flex:1;
}
.nav::-webkit-scrollbar{display:none}
.nav button{
  background:none;border:none;color:var(--t2);
  font-family:var(--sans);font-size:.78rem;font-weight:500;
  padding:0 12px;height:var(--top-h);
  cursor:pointer;white-space:nowrap;position:relative;
  transition:color .15s;
}
.nav button:hover{color:var(--t1)}
.nav button.active{color:var(--ok)}
.nav button.active::after{
  content:'';position:absolute;bottom:0;left:8px;right:8px;
  height:2px;background:var(--ok);border-radius:1px 1px 0 0;
}
.nav button .badge-count{
  font-size:.6rem;background:var(--err);color:#fff;
  border-radius:8px;padding:0 5px;margin-left:4px;
  font-weight:700;min-width:16px;text-align:center;
  display:inline-block;line-height:16px;vertical-align:middle;
}

/* â”€â”€â”€ SSE Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sse{
  font-size:.7rem;font-weight:600;padding:3px 10px;
  border-radius:10px;flex-shrink:0;font-family:var(--mono);
  transition:all .3s;
}
.sse.ok{background:rgba(0,255,136,.12);color:var(--ok)}
.sse.err{background:rgba(239,68,68,.12);color:var(--err)}
.sse.connecting{background:rgba(245,158,11,.12);color:var(--warn)}

/* â”€â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{max-width:1440px;margin:0 auto;padding:16px;width:100%}
.page{display:none;animation:fadeIn .2s ease}
.page.active{display:block}

/* â”€â”€â”€ KPI Strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-strip{
  display:flex;gap:10px;margin-bottom:16px;
  overflow-x:auto;-webkit-overflow-scrolling:touch;
  scroll-snap-type:x mandatory;scrollbar-width:none;
  padding-bottom:2px;
}
.kpi-strip::-webkit-scrollbar{display:none}
.kpi{
  background:var(--bg-s);border:1px solid var(--brd);
  border-radius:var(--radius);padding:14px 18px;
  min-width:160px;flex-shrink:0;scroll-snap-align:start;
  transition:border-color .2s;
}
.kpi:hover{border-color:var(--brd-h)}
.kpi .kpi-label{
  font-size:.65rem;color:var(--t2);text-transform:uppercase;
  letter-spacing:.08em;font-weight:500;margin-bottom:4px;
}
.kpi .kpi-val{
  font-family:var(--mono);font-size:1.6rem;font-weight:700;
  line-height:1.2;
}
.kpi .kpi-sub{font-size:.7rem;color:var(--t2);margin-top:2px;font-family:var(--mono)}
.v-green{color:var(--ok)}.v-blue{color:var(--info)}.v-yellow{color:var(--warn)}.v-red{color:var(--err)}.v-dim{color:var(--t2)}

/* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid{display:grid;gap:12px;margin-bottom:16px}
.g4{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.g3{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
.g2{grid-template-columns:repeat(auto-fit,minmax(380px,1fr))}
.card{
  background:var(--bg-s);border:1px solid var(--brd);
  border-radius:var(--radius);padding:16px;
  transition:border-color .2s;
}
.card:hover{border-color:var(--brd-h)}
.card-title{
  font-size:.85rem;font-weight:600;color:var(--t1);
  margin-bottom:12px;display:flex;align-items:center;gap:8px;
}
.card-title .icon{font-size:1rem;line-height:1}
.card-full{grid-column:1/-1}
.card-accent{border-top:2px solid var(--ok)}

/* â”€â”€â”€ Metric Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.metric{
  display:flex;justify-content:space-between;align-items:center;
  padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);
}
.metric:last-child{border-bottom:none}
.metric .mk{color:var(--t2);font-size:.8rem}
.metric .mv{font-family:var(--mono);font-size:.8rem;font-weight:600}

/* â”€â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prog{background:rgba(255,255,255,.06);border-radius:4px;height:6px;margin:6px 0;overflow:hidden}
.prog-fill{height:100%;border-radius:4px;transition:width .4s ease}
.prog-fill.green{background:linear-gradient(90deg,#00ff88,#00cc66)}
.prog-fill.yellow{background:linear-gradient(90deg,#f59e0b,#d97706)}
.prog-fill.red{background:linear-gradient(90deg,#ef4444,#b91c1c)}

/* â”€â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:2px 8px;border-radius:var(--radius-sm);
  font-size:.7rem;font-weight:600;font-family:var(--mono);
  line-height:1.4;
}
.b-ok{background:rgba(0,255,136,.1);color:var(--ok)}
.b-run{background:rgba(59,130,246,.1);color:var(--info)}
.b-warn{background:rgba(245,158,11,.1);color:var(--warn)}
.b-err{background:rgba(239,68,68,.1);color:var(--err)}
.b-dim{background:rgba(107,107,128,.1);color:var(--t2)}
.b-cc{background:rgba(168,85,247,.1);color:var(--cc)}
.b-cx{background:rgba(59,130,246,.1);color:var(--cx)}
.b-api{background:rgba(245,158,11,.1);color:var(--api)}
.b-loc{background:rgba(16,185,129,.1);color:var(--loc)}

/* Status dot inside badge */
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.dot-ok{background:var(--ok)}.dot-run{background:var(--info)}
.dot-warn{background:var(--warn)}.dot-err{background:var(--err)}
.dot-dim{background:var(--t3)}

/* â”€â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.tbl-scroll{max-height:520px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{
  text-align:left;padding:8px 10px;color:var(--t2);
  font-size:.68rem;text-transform:uppercase;letter-spacing:.06em;
  font-weight:600;border-bottom:1px solid var(--brd);
  position:sticky;top:0;background:var(--bg-s);z-index:2;
}
td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.03);font-family:var(--mono);font-size:.75rem}
tr{transition:background .15s}
tr:hover td{background:rgba(255,255,255,.02)}

/* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  background:var(--bg-e);border:1px solid var(--brd);color:var(--t1);
  padding:7px 14px;border-radius:var(--radius-sm);cursor:pointer;
  font-size:.78rem;font-family:var(--sans);font-weight:500;
  transition:all .15s;display:inline-flex;align-items:center;gap:5px;
  min-height:32px;white-space:nowrap;
}
.btn:hover{border-color:var(--brd-h);background:var(--bg-o)}
.btn:active{transform:scale(.97)}
.btn-p{background:var(--ok);color:#0a0a0f;border-color:var(--ok);font-weight:600}
.btn-p:hover{background:#00cc66;border-color:#00cc66}
.btn-d{border-color:rgba(239,68,68,.4);color:var(--err)}
.btn-d:hover{background:rgba(239,68,68,.1)}
.btn-sm{padding:3px 8px;font-size:.7rem;min-height:24px}
.btn-icon{padding:4px 8px;min-height:28px}
.btn[disabled]{opacity:.4;pointer-events:none}

/* â”€â”€â”€ Form Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input,.select{
  background:var(--bg);border:1px solid var(--brd);color:var(--t1);
  padding:7px 12px;border-radius:var(--radius-sm);font-size:.8rem;
  font-family:var(--sans);min-height:32px;
  transition:border-color .15s;
}
.input:focus,.select:focus{outline:none;border-color:var(--ok)}
.input::placeholder{color:var(--t3)}

/* â”€â”€â”€ Filters Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filters{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;align-items:center;gap:4px}
.filter-label{font-size:.7rem;color:var(--t2);font-weight:500}

/* â”€â”€â”€ Chart Containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-wrap{position:relative;height:260px;margin-top:6px}
.chart-wrap canvas{width:100%!important}

/* â”€â”€â”€ Sparkline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spark{display:flex;align-items:flex-end;gap:2px;height:22px}
.spark .bar{width:5px;border-radius:1.5px;min-height:2px;transition:height .3s}

/* â”€â”€â”€ DAG Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dag{display:flex;flex-direction:column;gap:6px;padding:8px 0}
.dag-step{
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;background:rgba(255,255,255,.03);
  border-radius:var(--radius);border-left:3px solid var(--info);
  cursor:pointer;transition:all .15s;
}
.dag-step:hover{background:rgba(255,255,255,.06)}
.dag-step.cc{border-left-color:var(--cc)}
.dag-step.codex{border-left-color:var(--cx)}
.dag-step.api{border-left-color:var(--api)}
.dag-step.local{border-left-color:var(--loc)}
.step-idx{
  width:26px;height:26px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;font-weight:700;font-family:var(--mono);flex-shrink:0;
}
.dag-step.cc .step-idx{background:rgba(168,85,247,.15);color:var(--cc)}
.dag-step.codex .step-idx{background:rgba(59,130,246,.15);color:var(--cx)}
.dag-step.api .step-idx{background:rgba(245,158,11,.15);color:var(--api)}
.dag-step.local .step-idx{background:rgba(16,185,129,.15);color:var(--loc)}
.step-body{flex:1;min-width:0}
.step-desc{font-size:.82rem;color:var(--t1)}
.step-meta{font-size:.68rem;color:var(--t2);margin-top:2px;font-family:var(--mono)}
.step-right{font-family:var(--mono);font-size:.72rem;color:var(--t2);text-align:right;white-space:nowrap;flex-shrink:0}

/* â”€â”€â”€ Config Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cfg-editor{
  background:var(--bg);border:1px solid var(--brd);border-radius:var(--radius);
  padding:14px;font-family:var(--mono);font-size:.78rem;color:var(--ok);
  width:100%;min-height:360px;resize:vertical;line-height:1.6;
  transition:border-color .15s;
}
.cfg-editor:focus{outline:none;border-color:var(--ok)}

/* â”€â”€â”€ Circuit Breaker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cb-strip{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.cb-item{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;background:var(--bg-s);border:1px solid var(--brd);
  border-radius:var(--radius);font-size:.78rem;min-width:180px;
}
.cb-name{font-weight:600;font-size:.75rem}
.cb-state{font-family:var(--mono);font-size:.7rem;font-weight:600}

/* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container{
  position:fixed;bottom:20px;right:16px;z-index:500;
  display:flex;flex-direction:column;gap:8px;
  pointer-events:none;padding-bottom:env(safe-area-inset-bottom,0);
}
.toast{
  background:var(--bg-s);border:1px solid var(--ok);color:var(--t1);
  padding:10px 16px;border-radius:var(--radius);font-size:.8rem;
  pointer-events:auto;transform:translateX(110%);
  transition:transform .3s cubic-bezier(.2,.8,.2,1);
  max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.4);
}
.toast.show{transform:translateX(0)}
.toast.error{border-color:var(--err)}

/* â”€â”€â”€ Command Palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cmd-overlay{
  position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:none;align-items:flex-start;justify-content:center;
  padding-top:min(20vh,120px);
}
.cmd-overlay.open{display:flex}
.cmd-box{
  background:var(--bg-s);border:1px solid var(--brd);
  border-radius:12px;width:min(520px,92vw);
  box-shadow:0 20px 60px rgba(0,0,0,.5);overflow:hidden;
  animation:cmdIn .15s ease;
}
@keyframes cmdIn{from{opacity:0;transform:scale(.96) translateY(-8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.cmd-input{
  width:100%;padding:14px 18px;background:transparent;
  border:none;border-bottom:1px solid var(--brd);
  color:var(--t1);font-size:.95rem;font-family:var(--sans);
}
.cmd-input:focus{outline:none}
.cmd-input::placeholder{color:var(--t3)}
.cmd-list{max-height:320px;overflow-y:auto;padding:6px}
.cmd-item{
  padding:10px 14px;border-radius:6px;cursor:pointer;
  display:flex;align-items:center;gap:10px;font-size:.82rem;
  transition:background .1s;
}
.cmd-item:hover,.cmd-item.selected{background:var(--bg-e)}
.cmd-item .cmd-key{
  font-family:var(--mono);font-size:.68rem;color:var(--t3);
  margin-left:auto;
}

/* â”€â”€â”€ Skeleton Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes shimmer{
  0%{background-position:-400px 0}
  100%{background-position:400px 0}
}
.skel{
  background:linear-gradient(90deg,var(--bg-s) 0%,var(--bg-e) 50%,var(--bg-s) 100%);
  background-size:800px 100%;animation:shimmer 1.5s infinite;
  border-radius:var(--radius-sm);
}

/* â”€â”€â”€ Keyboard Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kb-help{
  position:fixed;bottom:16px;left:16px;z-index:100;
  font-size:.68rem;color:var(--t3);font-family:var(--mono);
  padding-bottom:env(safe-area-inset-bottom,0);
}
.kb-help kbd{
  background:var(--bg-e);border:1px solid var(--brd);
  padding:1px 5px;border-radius:3px;font-size:.65rem;
}

/* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn .2s ease}
.pulse{animation:pulse 2s infinite}
.spinner{
  width:14px;height:14px;border:2px solid var(--brd);
  border-top-color:var(--ok);border-radius:50%;
  animation:spin .8s linear infinite;display:inline-block;
}

/* â”€â”€â”€ Mobile Cards (table alternative) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mobile-cards{display:none}
.m-card{
  background:var(--bg-s);border:1px solid var(--brd);
  border-radius:var(--radius);padding:12px 14px;margin-bottom:8px;
  transition:border-color .15s;
}
.m-card:active{border-color:var(--brd-h)}
.m-card-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.m-card-row:last-child{margin-bottom:0}
.m-card-title{font-size:.82rem;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.m-card-meta{font-size:.7rem;color:var(--t2);font-family:var(--mono)}
.m-card-actions{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.04)}
.queue-item{cursor:grab}
.queue-item:active{cursor:grabbing}
.queue-dragging{opacity:.5}
#queue-tbody .queue-drop-top td{box-shadow:inset 0 2px 0 0 var(--info)}
#queue-tbody .queue-drop-bottom td{box-shadow:inset 0 -2px 0 0 var(--info)}
#queue-mcards .queue-drop-top{box-shadow:inset 0 2px 0 0 var(--info)}
#queue-mcards .queue-drop-bottom{box-shadow:inset 0 -2px 0 0 var(--info)}

/* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:767px){
  :root{--top-h:48px}
  .content{padding:12px 10px}
  .logo span{display:none}
  .kpi{min-width:130px;padding:10px 14px}
  .kpi .kpi-val{font-size:1.3rem}
  .g4,.g3,.g2{grid-template-columns:1fr}
  .chart-wrap{height:180px}
  .filters{flex-direction:column;align-items:stretch}
  .filter-group{width:100%}
  .filter-group .input,.filter-group .select{flex:1}
  .kb-help{display:none}
  .desktop-table{display:none}
  .mobile-cards{display:block}
  .cb-strip{flex-direction:column}
  .cb-item{min-width:100%}
  td{font-size:.7rem;padding:6px 8px}
  th{font-size:.62rem;padding:6px 8px}
  .btn{min-height:38px;padding:8px 14px}
  .dag-step{padding:10px 12px;gap:8px}
  .step-right{display:none}
}
@media(max-width:479px){
  .kpi{min-width:110px;padding:8px 10px}
  .kpi .kpi-val{font-size:1.1rem}
  .nav button{padding:0 8px;font-size:.72rem}
}
@media(min-width:768px) and (max-width:1023px){
  .g4{grid-template-columns:repeat(2,1fr)}
}

/* â”€â”€â”€ Money Saved Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.money-saved-main{
  font-family:var(--mono);font-size:2.2rem;font-weight:700;
  color:var(--ok);line-height:1.1;margin-bottom:8px;
}
.money-saved-breakdown{
  display:flex;gap:16px;margin-bottom:6px;flex-wrap:wrap;
}
.money-saved-item{
  display:flex;flex-direction:column;align-items:center;
}
.money-saved-amount{
  font-family:var(--mono);font-size:.95rem;font-weight:600;
  color:var(--ok);
}
.money-saved-label{
  font-size:.65rem;color:var(--t2);text-transform:uppercase;
  letter-spacing:.08em;font-weight:500;
}
.money-saved-tasks{
  font-size:.75rem;color:var(--t2);margin-top:4px;
  font-family:var(--mono);
}

/* â”€â”€â”€ Trust Matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.trust-matrix{
  display:inline-block;min-width:100%;border:1px solid var(--brd);
  border-radius:var(--radius);overflow:hidden;
}
.trust-matrix table{
  font-size:.7rem;margin:0;
}
.trust-matrix th{
  background:var(--bg-e);padding:8px 6px;text-align:center;
  font-size:.65rem;
}
.trust-matrix td{
  padding:0;border:1px solid var(--brd);
  width:60px;height:32px;text-align:center;position:relative;
  cursor:pointer;transition:all .15s;
}
.trust-cell{
  display:flex;align-items:center;justify-content:center;
  width:100%;height:100%;font-size:.68rem;font-weight:600;
  font-family:var(--mono);
}
.trust-good{background:rgba(0,255,136,.2);color:var(--ok)}
.trust-promising{background:rgba(245,158,11,.2);color:var(--warn)}
.trust-bad{background:rgba(239,68,68,.2);color:var(--err)}
.trust-none{background:var(--bg);color:var(--t3)}
.trust-matrix td:hover{border-color:var(--brd-f);transform:scale(1.05);z-index:10}

/* â”€â”€â”€ Insight Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.insight-card{
  background:var(--bg-e);border:1px solid var(--brd);
  border-radius:var(--radius);padding:12px;margin-bottom:8px;
  transition:border-color .2s;
}
.insight-card:hover{border-color:var(--brd-h)}
.insight-card.trust{border-left:3px solid var(--ok)}
.insight-card.local{border-left:3px solid var(--loc)}
.insight-card.savings{border-left:3px solid var(--info)}
.insight-title{
  font-size:.8rem;font-weight:600;margin-bottom:4px;
}
.insight-message{
  font-size:.75rem;color:var(--t2);line-height:1.4;
}
.insight-meta{
  font-size:.68rem;color:var(--t3);margin-top:4px;
  font-family:var(--mono);
}

/* â”€â”€â”€ Feedback Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.feedback-item{
  border:1px solid var(--brd);border-radius:var(--radius);
  padding:12px;margin-bottom:8px;background:var(--bg-e);
  transition:border-color .2s;
}
.feedback-item:hover{border-color:var(--brd-h)}
.feedback-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
}
.feedback-task{
  font-size:.8rem;font-weight:500;color:var(--t1);
}
.feedback-score{
  font-family:var(--mono);font-size:.75rem;
  padding:2px 6px;border-radius:var(--radius-sm);
}
.feedback-outputs{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  margin-bottom:12px;
}
.feedback-output{
  background:var(--bg);border:1px solid var(--brd);
  border-radius:var(--radius-sm);padding:8px;
  max-height:120px;overflow-y:auto;
}
.feedback-output-title{
  font-size:.7rem;color:var(--t2);margin-bottom:4px;
  font-weight:600;text-transform:uppercase;
  letter-spacing:.05em;
}
.feedback-output-text{
  font-size:.72rem;font-family:var(--mono);
  color:var(--t1);line-height:1.4;
}
.feedback-actions{
  display:flex;justify-content:center;gap:8px;
}
.feedback-btn{
  padding:6px 20px;border-radius:20px;border:none;
  cursor:pointer;font-size:.75rem;font-weight:600;
  transition:all .15s;display:flex;align-items:center;gap:6px;
}
.feedback-btn.good{
  background:rgba(0,255,136,.15);color:var(--ok);
  border:1px solid rgba(0,255,136,.3);
}
.feedback-btn.bad{
  background:rgba(239,68,68,.15);color:var(--err);
  border:1px solid rgba(239,68,68,.3);
}
.feedback-btn:hover{transform:scale(1.05)}

/* â”€â”€â”€ Expandable Rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.expandable-row{cursor:pointer}
.expandable-row:hover td{background:rgba(255,255,255,.04)}
.expansion{
  display:none;background:var(--bg-e);
  border-top:1px solid var(--brd);
}
.expansion.open{display:block}
.expansion-content{
  padding:12px;font-size:.75rem;
}
.output-comparison{
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  margin-top:8px;
}
.output-section{
  background:var(--bg);border:1px solid var(--brd);
  border-radius:var(--radius-sm);padding:8px;
  max-height:200px;overflow-y:auto;
}
.output-header{
  font-size:.68rem;color:var(--t2);margin-bottom:6px;
  font-weight:600;text-transform:uppercase;
}
.output-text{
  font-family:var(--mono);font-size:.7rem;
  color:var(--t1);line-height:1.3;
  word-break:break-word;
}

/* â”€â”€â”€ Print (hidden) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media print{
  .topbar,.toast-container,.cmd-overlay,.kb-help{display:none!important}
  body{padding-top:0;background:#fff;color:#000}
  .card{border:1px solid #ddd;break-inside:avoid}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• Top Bar â•â•â•â•â•â•â•â•â•â•â• -->
<header class="topbar">
  <div class="logo">
    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    <span>OpenClaw</span>
  </div>
  <nav class="nav" id="nav">
    <button class="active" data-page="queue" data-key="1">Queue</button>
    <button data-page="costs" data-key="2">Costs</button>
    <button data-page="health" data-key="3">Health</button>
    <button data-page="plans" data-key="4">Plans</button>
    <button data-page="history" data-key="5">History</button>
    <button data-page="settings" data-key="6">Settings</button>
    <button data-page="benchmarks" data-key="7">Benchmarks</button>
  </nav>
  <div id="sse" class="sse connecting">...</div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â• Pages â•â•â•â•â•â•â•â•â•â•â• -->
<main class="content">

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 1: QUEUE â”â”â”â”â”â”â”â”â”â” -->
<section id="page-queue" class="page active">
  <div class="kpi-strip" id="queue-kpis"></div>
  <div id="money-saved-card" class="card card-accent" style="margin-bottom:16px;display:none">
    <div class="card-title" style="color:var(--ok);font-size:.9rem"><span class="icon">ğŸ’°</span> Money Saved by Subscriptions</div>
    <div id="money-saved-content"></div>
  </div>
  <div class="card card-full">
    <div class="card-title">
      <span class="icon">&#9654;</span> Live Queue
      <span style="margin-left:auto;font-size:.7rem;color:var(--t2);font-family:var(--mono)" id="queue-count"></span>
    </div>
    <div class="desktop-table">
      <div class="tbl-wrap tbl-scroll">
        <table>
          <thead><tr>
            <th>Status</th><th>Description</th><th>Backend</th><th>Priority</th><th>Enqueued</th><th style="width:120px">Actions</th>
          </tr></thead>
          <tbody id="queue-tbody"><tr><td colspan="6" style="text-align:center;color:var(--t2);padding:40px">
            <div class="spinner" style="margin:0 auto 8px"></div>Loading queue...
          </td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="mobile-cards" id="queue-mcards"></div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 2: COSTS â”â”â”â”â”â”â”â”â”â” -->
<section id="page-costs" class="page">
  <div class="kpi-strip" id="cost-kpis"></div>
  <div id="money-saved-card-costs" class="card card-accent" style="margin-bottom:16px;display:none">
    <div class="card-title" style="color:var(--ok);font-size:.9rem"><span class="icon">ğŸ’°</span> Money Saved by Subscriptions</div>
    <div id="money-saved-content-costs"></div>
  </div>
  <div class="grid g2">
    <div class="card">
      <div class="card-title"><span class="icon">&#9608;</span> Daily Spend</div>
      <div class="chart-wrap"><canvas id="ch-daily"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">&#9673;</span> Cost by Backend</div>
      <div class="chart-wrap"><canvas id="ch-pie"></canvas></div>
    </div>
  </div>
  <div class="grid g2">
    <div class="card">
      <div class="card-title"><span class="icon">&#8593;</span> Running Total vs Budget</div>
      <div class="chart-wrap"><canvas id="ch-running"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">&#10003;</span> Subscription Savings</div>
      <div class="chart-wrap"><canvas id="ch-savings"></canvas></div>
    </div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 3: HEALTH â”â”â”â”â”â”â”â”â”â” -->
<section id="page-health" class="page">
  <div class="grid g4" id="health-cards"></div>
  <div class="card card-full" style="margin-bottom:12px">
    <div class="card-title"><span class="icon">&#9889;</span> Circuit Breakers</div>
    <div class="cb-strip" id="cb-strip"></div>
  </div>
  <div class="card card-full">
    <div class="card-title">
      <span class="icon">&#9888;</span> Alerts
      <span style="margin-left:auto;font-size:.7rem;color:var(--t2);font-family:var(--mono)" id="alert-count"></span>
    </div>
    <div class="tbl-wrap tbl-scroll" style="max-height:280px">
      <table>
        <thead><tr><th>Level</th><th>Message</th><th>Time</th><th style="width:60px">Action</th></tr></thead>
        <tbody id="alerts-tbody"><tr><td colspan="4" style="text-align:center;color:var(--t2);padding:24px">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 4: PLANS â”â”â”â”â”â”â”â”â”â” -->
<section id="page-plans" class="page">
  <div class="card" style="margin-bottom:12px">
    <div class="card-title"><span class="icon">&#9881;</span> Create Plan</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="plan-desc" class="input" type="text" placeholder="Task description..." style="flex:1;min-width:180px">
      <select id="plan-type" class="select">
        <option value="code">Code</option><option value="research">Research</option>
        <option value="analysis">Analysis</option><option value="docs">Docs</option>
        <option value="review">Review</option><option value="other">Other</option>
      </select>
      <input id="plan-cpx" class="input" type="number" min="1" max="10" value="5" style="width:56px;text-align:center">
      <button class="btn btn-p" onclick="createPlan()">Decompose</button>
    </div>
  </div>
  <div id="pending-plans" style="display:none">
    <div class="card card-full" style="margin-bottom:12px">
      <div class="card-title"><span class="icon">&#128203;</span> Pending Plans</div>
      <div id="pending-list"></div>
    </div>
  </div>
  <div id="plan-result" style="display:none">
    <div class="kpi-strip" id="plan-kpis"></div>
    <div class="card card-full">
      <div class="card-title">
        <span class="icon">&#9654;</span> Execution Plan
        <span id="plan-id" style="font-size:.7rem;color:var(--t2);margin-left:8px;font-family:var(--mono)"></span>
      </div>
      <div id="plan-dag" class="dag"></div>
      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-p" id="plan-approve" onclick="approvePlan()">Approve & Execute</button>
        <button class="btn btn-d" onclick="cancelPlan()">Cancel</button>
      </div>
    </div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 5: HISTORY â”â”â”â”â”â”â”â”â”â” -->
<section id="page-history" class="page">
  <div class="filters">
    <div class="filter-group">
      <span class="filter-label">From</span>
      <input type="date" id="hist-from" class="input">
    </div>
    <div class="filter-group">
      <span class="filter-label">To</span>
      <input type="date" id="hist-to" class="input">
    </div>
    <div class="filter-group">
      <span class="filter-label">Backend</span>
      <select id="hist-backend" class="select">
        <option value="">All</option>
        <option>claudeCode</option><option>codex</option>
        <option>api</option><option>local</option>
      </select>
    </div>
    <div class="filter-group">
      <span class="filter-label">Limit</span>
      <input type="number" id="hist-limit" class="input" value="100" min="10" max="1000" style="width:72px">
    </div>
    <button class="btn btn-p" onclick="loadHistory()">Search</button>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
  </div>
  <div class="card card-full">
    <div class="card-title">
      <span class="icon">&#128196;</span> Task History
      <span style="margin-left:auto;font-size:.7rem;color:var(--t2);font-family:var(--mono)" id="hist-count"></span>
    </div>
    <div class="desktop-table">
      <div class="tbl-wrap tbl-scroll">
        <table>
          <thead><tr>
            <th>Time</th><th>Result</th><th>Backend</th><th>Type</th><th>Duration</th><th>Tokens</th><th>Cost</th>
          </tr></thead>
          <tbody id="hist-tbody"><tr><td colspan="7" style="text-align:center;color:var(--t2);padding:40px">Use filters and click Search</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="mobile-cards" id="hist-mcards"></div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 6: SETTINGS â”â”â”â”â”â”â”â”â”â” -->
<section id="page-settings" class="page">
  <div class="grid g2">
    <div class="card">
      <div class="card-title"><span class="icon">&#9998;</span> Edit Configuration</div>
      <textarea id="cfg-edit" class="cfg-editor"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn btn-p" onclick="saveConfig()">Save</button>
        <button class="btn" onclick="loadConfig()">Reload</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title"><span class="icon">&#128065;</span> Current Config</div>
      <pre id="cfg-ro" style="font-family:var(--mono);font-size:.75rem;color:var(--t2);white-space:pre-wrap;max-height:460px;overflow-y:auto;line-height:1.5"></pre>
    </div>
  </div>
  <div class="card card-full" style="margin-top:12px">
    <div class="card-title"><span class="icon">&#9881;</span> Quick Actions</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="apiPost('/api/scheduler/pause')">Pause Scheduler</button>
      <button class="btn" onclick="apiPost('/api/scheduler/resume')">Resume Scheduler</button>
      <button class="btn" onclick="pingAll()">Ping All Backends</button>
      <button class="btn btn-d" onclick="if(confirm('Reset all circuit breakers?'))resetBreakers()">Reset Breakers</button>
    </div>
  </div>
  <div class="card card-full" style="margin-top:12px">
    <div class="card-title"><span class="icon">&#9000;</span> Keyboard Shortcuts</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;font-size:.78rem">
      <div><kbd style="background:var(--bg-e);border:1px solid var(--brd);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.7rem">1-7</kbd> <span style="color:var(--t2);margin-left:4px">Switch views</span></div>
      <div><kbd style="background:var(--bg-e);border:1px solid var(--brd);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.7rem">&#8984;K</kbd> <span style="color:var(--t2);margin-left:4px">Command palette</span></div>
      <div><kbd style="background:var(--bg-e);border:1px solid var(--brd);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.7rem">R</kbd> <span style="color:var(--t2);margin-left:4px">Refresh view</span></div>
      <div><kbd style="background:var(--bg-e);border:1px solid var(--brd);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.7rem">Esc</kbd> <span style="color:var(--t2);margin-left:4px">Close overlay</span></div>
      <div><kbd style="background:var(--bg-e);border:1px solid var(--brd);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:.7rem">?</kbd> <span style="color:var(--t2);margin-left:4px">Toggle shortcuts</span></div>
    </div>
  </div>
</section>

<!-- â”â”â”â”â”â”â”â”â”â” PAGE 7: BENCHMARKS â”â”â”â”â”â”â”â”â”â” -->
<section id="page-benchmarks" class="page">
  <div class="grid g2">
    <div class="card card-full">
      <div class="card-title"><span class="icon">ğŸ¯</span> Trust Matrix</div>
      <div id="trust-matrix" style="overflow-x:auto;-webkit-overflow-scrolling:touch">
        <div style="text-align:center;color:var(--t2);padding:40px">Loading trust matrix...</div>
      </div>
    </div>
  </div>
  
  <div class="grid g2" style="margin-top:12px">
    <div class="card">
      <div class="card-title">
        <span class="icon">ğŸ“Š</span> Recent Comparisons
        <span style="margin-left:auto;font-size:.7rem;color:var(--t2);font-family:var(--mono)" id="comparison-count">0 results</span>
      </div>
      <div class="tbl-wrap tbl-scroll" style="max-height:320px">
        <table>
          <thead><tr>
            <th>Task Type</th><th>Model</th><th>Score</th><th>Time</th><th style="width:80px">Actions</th>
          </tr></thead>
          <tbody id="comparison-tbody">
            <tr><td colspan="5" style="text-align:center;color:var(--t2);padding:24px">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="mobile-cards" id="comparison-mcards" style="max-height:320px;overflow-y:auto"></div>
    </div>
    
    <div class="card">
      <div class="card-title"><span class="icon">ğŸ’¡</span> Insights</div>
      <div id="insights-container" style="max-height:320px;overflow-y:auto">
        <div style="text-align:center;color:var(--t2);padding:40px">Loading insights...</div>
      </div>
    </div>
  </div>
  
  <div class="card card-full" style="margin-top:12px">
    <div class="card-title">
      <span class="icon">ğŸ‘</span> Feedback Queue
      <span style="margin-left:auto;font-size:.7rem;color:var(--t2);font-family:var(--mono)" id="feedback-count">0 pending</span>
    </div>
    <div id="feedback-queue">
      <div style="text-align:center;color:var(--t2);padding:40px">Loading feedback queue...</div>
    </div>
  </div>
</section>

</main>

<!-- â•â•â•â•â•â•â•â•â•â•â• Toast Container â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast-container" id="toasts"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• Command Palette â•â•â•â•â•â•â•â•â•â•â• -->
<div class="cmd-overlay" id="cmd-overlay">
  <div class="cmd-box">
    <input class="cmd-input" id="cmd-input" placeholder="Type a command..." autocomplete="off">
    <div class="cmd-list" id="cmd-list"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• Keyboard Help â•â•â•â•â•â•â•â•â•â•â• -->
<div class="kb-help" id="kb-help">
  <kbd>&#8984;K</kbd> commands &nbsp; <kbd>1-6</kbd> views &nbsp; <kbd>R</kbd> refresh &nbsp; <kbd>?</kbd> help
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OpenClaw Router Dashboard v2 â€” JavaScript
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '';
let authToken = new URLSearchParams(location.search).get('token') || '';
let evtSource = null;
let charts = {};
let currentPlanId = null;
let historyData = [];
let activePage = 'queue';
let alertCount = 0;

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authUrl(path) {
  const sep = path.includes('?') ? '&' : '?';
  return authToken ? `${API}${path}${sep}token=${authToken}` : `${API}${path}`;
}

async function apiFetch(path) {
  const r = await fetch(authUrl(path));
  if (r.status === 401) { toast('Auth required â€” add ?token=... to URL', true); throw new Error('401'); }
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function apiPost(path, body) {
  const r = await fetch(authUrl(path), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : undefined
  });
  const data = await r.json();
  toast(data.message || (data.success ? 'Done' : 'Failed'), !data.success && !data.message);
  return data;
}

async function apiPut(path, body) {
  const r = await fetch(authUrl(path), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return r.json();
}

// â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, isError) {
  const container = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast' + (isError ? ' error' : '');
  el.textContent = msg;
  container.appendChild(el);
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('show')));
  setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

// â”€â”€â”€ Format Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return Math.round(diff / 1000) + 's ago';
  if (diff < 3600000) return Math.round(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.round(diff / 3600000) + 'h ago';
  return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}

function fmtTimeFull(iso) {
  if (!iso) return '-';
  return new Date(iso).toLocaleString(undefined, {
    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
}

function fmtDur(ms) {
  if (!ms) return '-';
  if (ms < 1000) return ms + 'ms';
  if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
  return (ms / 60000).toFixed(1) + 'm';
}

function fmtCost(usd) {
  if (!usd || usd === 0) return '$0';
  if (usd < 0.01) return '$' + usd.toFixed(4);
  if (usd < 1) return '$' + usd.toFixed(3);
  return '$' + usd.toFixed(2);
}

function fmtTokens(n) {
  if (!n) return '0';
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

function progClass(pct) { return pct > 80 ? 'red' : pct > 60 ? 'yellow' : 'green'; }

function backendBadge(name) {
  const map = { claudeCode: 'b-cc', 'claude-code': 'b-cc', codex: 'b-cx', api: 'b-api', local: 'b-loc' };
  const display = { claudeCode: 'Claude', 'claude-code': 'Claude', codex: 'Codex', api: 'API', local: 'Local' };
  return `<span class="badge ${map[name] || 'b-dim'}">${display[name] || name}</span>`;
}

function statusBadge(status) {
  const map = {
    running: ['b-run', 'dot-run'], queued: ['b-dim', 'dot-dim'], scheduled: ['b-dim', 'dot-dim'],
    online: ['b-ok', 'dot-ok'], offline: ['b-err', 'dot-err'],
    throttled: ['b-warn', 'dot-warn'], degraded: ['b-warn', 'dot-warn'],
    success: ['b-ok', 'dot-ok'], fail: ['b-err', 'dot-err'],
  };
  const [bc, dc] = map[status] || ['b-dim', 'dot-dim'];
  return `<span class="badge ${bc}"><span class="dot ${dc}"></span>${status}</span>`;
}

function priorityBadge(name) {
  const map = { urgent: 'b-err', normal: 'b-run', background: 'b-dim' };
  return `<span class="badge ${map[name] || 'b-dim'}">${name || 'normal'}</span>`;
}

function sparkHTML(data) {
  if (!data || data.length === 0) return '';
  const max = Math.max(...data.filter(v => v !== null), 1);
  return '<div class="spark">' + data.map(v => {
    if (v === null) return '<div class="bar" style="height:2px;background:var(--t3)"></div>';
    const h = Math.max(2, (v / max) * 22);
    const c = v >= 80 ? 'var(--ok)' : v >= 50 ? 'var(--warn)' : 'var(--err)';
    return `<div class="bar" style="height:${h}px;background:${c}"></div>`;
  }).join('') + '</div>';
}

function estimateApiCost(tokens) {
  const inp = tokens * 0.7;
  const out = tokens * 0.3;
  return (inp * 3 / 1000000) + (out * 15 / 1000000);
}

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchPage(page) {
  activePage = page;
  document.querySelectorAll('.nav button').forEach(b => b.classList.toggle('active', b.dataset.page === page));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + page));

  // Ensure active tab visible on mobile
  const activeBtn = document.querySelector(`.nav button[data-page="${page}"]`);
  if (activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

  // Load page data
  refreshPage(page);
}

function refreshPage(page) {
  page = page || activePage;
  switch (page) {
    case 'queue': loadQueue(); break;
    case 'costs': loadCosts(); break;
    case 'health': loadHealth(); break;
    case 'plans': loadPendingPlans(); break;
    case 'history': break; // on-demand only
    case 'settings': loadConfig(); break;
    case 'benchmarks': loadBenchmarks(); break;
  }
}

document.getElementById('nav').addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (btn && btn.dataset.page) switchPage(btn.dataset.page);
});

// â”€â”€â”€ SSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectSSE() {
  if (evtSource) evtSource.close();
  const sse = document.getElementById('sse');
  sse.textContent = '...';
  sse.className = 'sse connecting';

  evtSource = new EventSource(authUrl('/api/events'));

  evtSource.addEventListener('connected', () => {
    sse.textContent = 'Live';
    sse.className = 'sse ok';
  });

  evtSource.addEventListener('status', () => {
    if (activePage === 'queue') loadQueue();
  });

  evtSource.addEventListener('queue-update', () => {
    loadQueue();
  });

  evtSource.addEventListener('plan-created', () => {
    toast('New plan created');
    if (activePage === 'plans') loadPendingPlans();
  });

  evtSource.addEventListener('plan-executed', () => {
    if (activePage === 'plans') loadPendingPlans();
  });

  evtSource.addEventListener('config-updated', () => {
    toast('Config updated');
    if (activePage === 'settings') loadConfig();
  });

  evtSource.addEventListener('breaker-update', () => {
    if (activePage === 'health') loadHealth();
  });

  evtSource.addEventListener('health-update', () => {
    if (activePage === 'health') loadHealth();
  });

  evtSource.addEventListener('scheduler-update', (e) => {
    try {
      const d = JSON.parse(e.data);
      toast(d.paused ? 'Scheduler paused' : 'Scheduler resumed');
    } catch (_) {}
  });

  evtSource.onerror = () => {
    sse.textContent = 'Offline';
    sse.className = 'sse err';
    setTimeout(connectSSE, 5000);
  };
}

// â”€â”€â”€ Money Saved KPI Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMoneySaved() {
  try {
    const savings = await apiFetch('/api/savings');
    const content = `
      <div class="money-saved-main">${fmtCost(savings.totalSaved)}</div>
      <div class="money-saved-breakdown">
        <div class="money-saved-item">
          <div class="money-saved-amount">${fmtCost(savings.todaySaved)}</div>
          <div class="money-saved-label">Today</div>
        </div>
        <div class="money-saved-item">
          <div class="money-saved-amount">${fmtCost(savings.weekSaved)}</div>
          <div class="money-saved-label">This Week</div>
        </div>
        <div class="money-saved-item">
          <div class="money-saved-amount">${fmtCost(savings.monthSaved)}</div>
          <div class="money-saved-label">This Month</div>
        </div>
      </div>
      <div class="money-saved-tasks">Across ${savings.taskCount} tasks</div>
    `;
    
    // Show on both queue and costs pages
    const queueCard = document.getElementById('money-saved-card');
    const costsCard = document.getElementById('money-saved-card-costs');
    const queueContent = document.getElementById('money-saved-content');
    const costsContent = document.getElementById('money-saved-content-costs');
    
    if (queueContent) queueContent.innerHTML = content;
    if (costsContent) costsContent.innerHTML = content;
    
    // Show cards if we have significant savings
    if (savings.totalSaved > 0.01) {
      if (queueCard) queueCard.style.display = 'block';
      if (costsCard) costsCard.style.display = 'block';
    }
  } catch (e) { console.error('loadMoneySaved:', e); }
}

// â”€â”€â”€ PAGE 1: Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadQueue() {
  try {
    const [q, stats] = await Promise.all([apiFetch('/api/queue'), apiFetch('/api/stats')]);

    // KPI strip
    document.getElementById('queue-kpis').innerHTML = `
      <div class="kpi"><div class="kpi-label">Running</div><div class="kpi-val v-blue">${q.summary.running}</div></div>
      <div class="kpi"><div class="kpi-label">Queued</div><div class="kpi-val v-yellow">${q.summary.queued}</div></div>
      <div class="kpi"><div class="kpi-label">Total Tasks</div><div class="kpi-val v-green">${stats.totalTasks}</div></div>
      <div class="kpi"><div class="kpi-label">Success Rate</div><div class="kpi-val ${stats.successRate >= 80 ? 'v-green' : stats.successRate >= 50 ? 'v-yellow' : 'v-red'}">${stats.successRate}%</div></div>
      <div class="kpi"><div class="kpi-label">Alerts</div><div class="kpi-val ${stats.activeAlerts > 0 ? 'v-red' : 'v-green'}">${stats.activeAlerts}</div></div>
      <div class="kpi"><div class="kpi-label">Today Spend</div><div class="kpi-val v-blue">${fmtCost(stats.dailySpendUsd)}</div></div>
    `;

    // Update alert badge in nav
    alertCount = stats.activeAlerts;
    updateNavBadges();

    document.getElementById('queue-count').textContent = `${q.items.length} items`;

    // Desktop table
    const tbody = document.getElementById('queue-tbody');
    if (q.items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--t2);padding:40px">Queue empty â€” all clear</td></tr>';
      document.getElementById('queue-mcards').innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">Queue empty</div>';
      return;
    }

    tbody.innerHTML = q.items.map(item => `
      <tr class="fade-in queue-item" draggable="true" data-task-id="${item.id}">
        <td>${statusBadge(item.status)}</td>
        <td style="color:var(--t1);max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(item.task?.description || item.description || '-')}</td>
        <td>${backendBadge(item.backend || item.source)}</td>
        <td>${priorityBadge(item.priorityName)}</td>
        <td>${fmtTime(item.enqueuedAt || item.startedAt)}</td>
        <td>${item.status === 'running'
          ? '<span class="badge b-run"><span class="spinner" style="width:10px;height:10px;border-width:1.5px;margin-right:4px"></span>Running</span>'
          : `<button class="btn btn-sm btn-d" onclick="cancelTask('${item.id}')">Cancel</button>
             <select class="select" style="font-size:.68rem;padding:2px 4px;min-height:24px" onchange="reprioritize('${item.id}',this.value)">
               <option value="" disabled selected>Pri</option>
               <option value="urgent">Urgent</option>
               <option value="normal">Normal</option>
               <option value="background">Background</option>
             </select>`
        }</td>
      </tr>
    `).join('');

    // Mobile cards
    document.getElementById('queue-mcards').innerHTML = q.items.map(item => `
      <div class="m-card fade-in queue-item" draggable="true" data-task-id="${item.id}">
        <div class="m-card-row">
          ${statusBadge(item.status)}
          <span class="m-card-meta">${fmtTime(item.enqueuedAt || item.startedAt)}</span>
        </div>
        <div class="m-card-row">
          <span class="m-card-title">${esc(item.task?.description || item.description || '-')}</span>
        </div>
        <div class="m-card-row">
          ${backendBadge(item.backend || item.source)}
          ${priorityBadge(item.priorityName)}
        </div>
        ${item.status !== 'running' ? `
          <div class="m-card-actions">
            <button class="btn btn-sm btn-d" onclick="cancelTask('${item.id}')">Cancel</button>
            <button class="btn btn-sm" onclick="reprioritize('${item.id}','urgent')">Urgent</button>
            <button class="btn btn-sm" onclick="reprioritize('${item.id}','background')">Background</button>
          </div>
        ` : ''}
      </div>
    `).join('');
    setupQueueDragAndDrop();

    // Load money saved card
    loadMoneySaved();

  } catch (e) { console.error('loadQueue:', e); }
}

async function cancelTask(id) {
  await apiPost(`/api/queue/${id}/cancel`);
  loadQueue();
}

async function reprioritize(id, pri) {
  if (!pri) return;
  await apiPost(`/api/queue/${id}/priority`, { priority: pri });
  loadQueue();
}

let queueDragInitialized = false;
const queueDragState = { draggingEl: null, startIndex: -1, container: null, longPressTimer: null };

function setupQueueDragAndDrop() {
  const tbody = document.getElementById('queue-tbody');
  const mcards = document.getElementById('queue-mcards');
  if (!tbody || !mcards) return;

  const items = document.querySelectorAll('#queue-tbody .queue-item, #queue-mcards .queue-item');
  items.forEach(item => {
    if (item.dataset.dragBound === '1') return;
    item.dataset.dragBound = '1';
    item.dataset.dragArmed = '0';
    item.addEventListener('dragstart', queueHandleDragStart);
    item.addEventListener('dragend', queueHandleDragEnd);
    item.addEventListener('pointerdown', queueHandlePointerDown);
    item.addEventListener('pointerup', queueHandlePointerUp);
    item.addEventListener('pointercancel', queueHandlePointerUp);
    item.addEventListener('pointerleave', queueHandlePointerUp);
  });

  if (queueDragInitialized) return;
  queueDragInitialized = true;
  [tbody, mcards].forEach(container => {
    container.addEventListener('dragover', queueHandleDragOver);
    container.addEventListener('dragleave', queueHandleDragLeave);
    container.addEventListener('drop', queueHandleDrop);
  });
}

function queueHandleDragStart(e) {
  const el = e.currentTarget;
  if (isTouchDevice() && el.dataset.dragArmed !== '1') {
    e.preventDefault();
    return;
  }
  queueDragState.draggingEl = el;
  queueDragState.container = el.closest('#queue-tbody, #queue-mcards');
  queueDragState.startIndex = Array.from(queueDragState.container.querySelectorAll('.queue-item')).indexOf(el);
  el.classList.add('queue-dragging');
  if (e.dataTransfer) {
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', el.dataset.taskId || '');
  }
}

function queueHandleDragEnd(e) {
  const el = e.currentTarget;
  el.classList.remove('queue-dragging');
  el.dataset.dragArmed = '0';
  if (queueDragState.container) clearQueueDropIndicators(queueDragState.container);
  queueDragState.draggingEl = null;
  queueDragState.container = null;
  queueDragState.startIndex = -1;
}

function queueHandlePointerDown(e) {
  if (!isTouchDevice() || e.pointerType !== 'touch') return;
  if (e.target.closest('button, select, input, textarea, a')) return;
  const el = e.currentTarget;
  clearTimeout(queueDragState.longPressTimer);
  queueDragState.longPressTimer = setTimeout(() => {
    el.dataset.dragArmed = '1';
  }, 500);
}

function queueHandlePointerUp(e) {
  if (!isTouchDevice()) return;
  clearTimeout(queueDragState.longPressTimer);
  if (e.currentTarget !== queueDragState.draggingEl) {
    e.currentTarget.dataset.dragArmed = '0';
  }
}

function queueHandleDragOver(e) {
  if (!queueDragState.draggingEl) return;
  const container = e.currentTarget;
  if (container !== queueDragState.container) return;
  e.preventDefault();
  const target = e.target.closest('.queue-item');
  if (!target || target === queueDragState.draggingEl) {
    clearQueueDropIndicators(container);
    return;
  }
  const rect = target.getBoundingClientRect();
  const before = e.clientY < rect.top + rect.height / 2;
  clearQueueDropIndicators(container);
  target.classList.add(before ? 'queue-drop-top' : 'queue-drop-bottom');
}

function queueHandleDragLeave(e) {
  if (e.currentTarget.contains(e.relatedTarget)) return;
  clearQueueDropIndicators(e.currentTarget);
}

function queueHandleDrop(e) {
  if (!queueDragState.draggingEl) return;
  const container = e.currentTarget;
  if (container !== queueDragState.container) return;
  e.preventDefault();
  const dragEl = queueDragState.draggingEl;
  const target = e.target.closest('.queue-item');
  clearQueueDropIndicators(container);

  if (target && target !== dragEl) {
    const rect = target.getBoundingClientRect();
    const before = e.clientY < rect.top + rect.height / 2;
    container.insertBefore(dragEl, before ? target : target.nextSibling);
  } else if (!target) {
    container.appendChild(dragEl);
  }

  const items = Array.from(container.querySelectorAll('.queue-item'));
  const newIndex = items.indexOf(dragEl);
  if (newIndex !== queueDragState.startIndex && newIndex >= 0) {
    queueDragState.startIndex = newIndex;
    updateQueuePriority(dragEl.dataset.taskId, newIndex + 1);
  }
}

function clearQueueDropIndicators(container) {
  container.querySelectorAll('.queue-drop-top,.queue-drop-bottom').forEach(el => {
    el.classList.remove('queue-drop-top', 'queue-drop-bottom');
  });
}

function isTouchDevice() {
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

async function updateQueuePriority(id, newPriority) {
  if (!id) return;
  try {
    await apiPost(`/api/queue/${id}/priority`, { priority: newPriority });
    loadQueue();
  } catch (e) {
    console.error('updateQueuePriority:', e);
  }
}

// â”€â”€â”€ PAGE 2: Costs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCosts() {
  try {
    const data = await apiFetch('/api/costs?period=month');

    document.getElementById('cost-kpis').innerHTML = `
      <div class="kpi"><div class="kpi-label">Today</div><div class="kpi-val v-blue">${fmtCost(data.current.dailySpend)}</div></div>
      <div class="kpi"><div class="kpi-label">This Month</div><div class="kpi-val v-yellow">${fmtCost(data.current.monthlySpend)}</div></div>
      <div class="kpi"><div class="kpi-label">Projected/Mo</div><div class="kpi-val ${data.projectedMonthlyUsd > (data.current.monthlyBudget || 9999) ? 'v-red' : 'v-green'}">${fmtCost(data.projectedMonthlyUsd)}</div></div>
      <div class="kpi"><div class="kpi-label">Saved by Subs</div><div class="kpi-val v-green">${fmtCost(data.savedBySubscriptionUsd)}</div></div>
    `;

    const days = data.dailyCosts || [];
    const labels = days.map(d => d.date.slice(5));
    const colors = { gridColor: 'rgba(255,255,255,.04)', tickColor: '#444', legendColor: '#777' };

    // Daily spend
    destroyChart('ch-daily');
    charts['ch-daily'] = new Chart(document.getElementById('ch-daily'), {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'API Spend', data: days.map(d => d.api), backgroundColor: 'rgba(59,130,246,0.6)', borderRadius: 3, barPercentage: 0.7 },
          { label: 'Sub Would-Cost', data: days.map(d => d.subscription), backgroundColor: 'rgba(0,255,136,0.15)', borderRadius: 3, barPercentage: 0.7 }
        ]
      },
      options: makeChartOpts('$', colors)
    });

    // Backend pie
    const bc = data.backendCosts;
    destroyChart('ch-pie');
    charts['ch-pie'] = new Chart(document.getElementById('ch-pie'), {
      type: 'doughnut',
      data: {
        labels: ['Claude Code', 'Codex', 'API', 'Local'],
        datasets: [{
          data: [bc.claudeCode, bc.codex, bc.api, bc.local],
          backgroundColor: ['#a855f7', '#3b82f6', '#f59e0b', '#10b981'],
          borderWidth: 0, borderRadius: 2
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: { position: window.innerWidth < 768 ? 'bottom' : 'right', labels: { color: colors.legendColor, font: { size: 11, family: "'Inter', sans-serif" }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } }
        }
      }
    });

    // Running total
    destroyChart('ch-running');
    charts['ch-running'] = new Chart(document.getElementById('ch-running'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Running Total', data: days.map(d => d.runningTotal), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.08)', fill: true, tension: 0.3, pointRadius: 1.5, borderWidth: 2 },
          { label: 'Budget', data: days.map(() => data.current.dailyBudget), borderColor: 'rgba(239,68,68,0.4)', borderDash: [6, 4], pointRadius: 0, fill: false, borderWidth: 1.5 }
        ]
      },
      options: makeChartOpts('$', colors)
    });

    // Savings
    destroyChart('ch-savings');
    let cumSaved = 0;
    const cumSavings = days.map(d => { cumSaved += (d.subscription || 0); return Math.round(cumSaved * 100) / 100; });
    charts['ch-savings'] = new Chart(document.getElementById('ch-savings'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Cumulative Savings', data: cumSavings,
          borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.06)',
          fill: true, tension: 0.3, pointRadius: 1.5, borderWidth: 2
        }]
      },
      options: makeChartOpts('$', colors)
    });

    // Load money saved card
    loadMoneySaved();
  } catch (e) { console.error('loadCosts:', e); }
}

function makeChartOpts(prefix, c) {
  return {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    scales: {
      x: { ticks: { color: c.tickColor, font: { size: 10, family: "'JetBrains Mono', monospace" } }, grid: { color: c.gridColor } },
      y: { ticks: { color: c.tickColor, font: { size: 10, family: "'JetBrains Mono', monospace" }, callback: v => prefix + v }, grid: { color: c.gridColor } }
    },
    plugins: {
      legend: { labels: { color: c.legendColor, font: { size: 11, family: "'Inter', sans-serif" }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } },
      tooltip: { backgroundColor: '#1a1a26', borderColor: '#2a2a3e', borderWidth: 1, titleFont: { family: "'Inter', sans-serif" }, bodyFont: { family: "'JetBrains Mono', monospace", size: 12 }, padding: 10, cornerRadius: 6 }
    }
  };
}

function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

// â”€â”€â”€ PAGE 3: Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHealth() {
  try {
    const [backends, alerts, breakers] = await Promise.all([
      apiFetch('/api/backends'),
      apiFetch('/api/alerts'),
      apiFetch('/api/breakers').catch(() => ({}))
    ]);

    const container = document.getElementById('health-cards');
    const names = { claudeCode: 'Claude Code', codex: 'Codex', api: 'API Sub-agents', local: 'Local (Ollama)' };
    const accentColors = { claudeCode: 'var(--cc)', codex: 'var(--cx)', api: 'var(--api)', local: 'var(--loc)' };

    container.innerHTML = Object.entries(backends).map(([key, b]) => {
      const pct = b.sessionUsage || 0;
      const cooldownLeft = b.lastCompletion && b.cooldownMs
        ? Math.max(0, Math.round((new Date(b.lastCompletion).getTime() + b.cooldownMs - Date.now()) / 1000))
        : 0;

      let extras = '';
      if (key === 'claudeCode') {
        const usagePct = b.maxUsage ? (pct / b.maxUsage * 100) : 0;
        extras = `
          <div class="metric"><span class="mk">Session</span><span class="mv">${pct.toFixed(1)}% / ${b.maxUsage}%</span></div>
          <div class="prog"><div class="prog-fill ${progClass(usagePct)}" style="width:${Math.min(100, usagePct)}%"></div></div>
          <div class="metric"><span class="mk">Cooldown</span><span class="mv">${cooldownLeft > 0 ? cooldownLeft + 's' : 'Ready'}</span></div>
        `;
      } else if (key === 'codex') {
        const slotPct = (b.activeSlots || 0) / (b.concurrencySlots || 3) * 100;
        extras = `
          <div class="metric"><span class="mk">Slots</span><span class="mv">${b.activeSlots || 0} / ${b.concurrencySlots || 3}</span></div>
          <div class="prog"><div class="prog-fill ${progClass(slotPct)}" style="width:${slotPct}%"></div></div>
          <div class="metric"><span class="mk">Cooldown</span><span class="mv">${cooldownLeft > 0 ? cooldownLeft + 's' : 'Ready'}</span></div>
        `;
      } else if (key === 'api') {
        const dailyPct = b.dailyBudget ? (b.dailySpend / b.dailyBudget * 100) : 0;
        extras = `
          <div class="metric"><span class="mk">Daily Spend</span><span class="mv">${fmtCost(b.dailySpend)} / ${fmtCost(b.dailyBudget)}</span></div>
          <div class="prog"><div class="prog-fill ${progClass(dailyPct)}" style="width:${Math.min(100, dailyPct)}%"></div></div>
          <div class="metric"><span class="mk">Model</span><span class="mv" style="font-size:.68rem">${((b.model || '').split('/').pop())}</span></div>
        `;
      } else {
        extras = `
          <div class="metric"><span class="mk">Tasks Today</span><span class="mv">${b.taskCount || 0}</span></div>
          <div class="metric"><span class="mk">Total</span><span class="mv">${b.totalTasks || 0}</span></div>
        `;
      }

      return `<div class="card" style="border-top:2px solid ${accentColors[key]}">
        <div class="card-title" style="font-size:.82rem">${names[key]} <span style="margin-left:auto">${statusBadge(b.status)}</span></div>
        <div class="metric"><span class="mk">Success</span><span class="mv" style="color:${b.successRate >= 80 ? 'var(--ok)' : b.successRate >= 50 ? 'var(--warn)' : 'var(--err)'}">${b.successRate}%</span></div>
        <div class="metric"><span class="mk">Avg Duration</span><span class="mv">${fmtDur(b.avgDurationMs)}</span></div>
        <div class="metric"><span class="mk">Score</span><span class="mv">${b.adaptiveScore ?? '-'}</span></div>
        <div class="metric"><span class="mk">Last Used</span><span class="mv" style="font-size:.68rem">${fmtTime(b.lastUsed)}</span></div>
        <div class="metric"><span class="mk">7-day</span><span class="mv">${sparkHTML(b.sparkline)}</span></div>
        ${extras}
      </div>`;
    }).join('');

    // Circuit breakers
    const cbStrip = document.getElementById('cb-strip');
    if (breakers && typeof breakers === 'object' && Object.keys(breakers).length > 0) {
      cbStrip.innerHTML = Object.entries(breakers).map(([name, state]) => {
        const st = state?.state || state || 'unknown';
        const stLower = String(st).toLowerCase();
        const dotClass = stLower === 'closed' ? 'dot-ok' : stLower === 'open' ? 'dot-err' : 'dot-warn';
        const stateClass = stLower === 'closed' ? 'v-green' : stLower === 'open' ? 'v-red' : 'v-yellow';
        return `<div class="cb-item">
          <span class="dot ${dotClass}"></span>
          <span class="cb-name">${name}</span>
          <span class="cb-state ${stateClass}">${stLower}</span>
          ${stLower !== 'closed' ? `<button class="btn btn-sm" style="margin-left:auto" onclick="resetBreaker('${name}')">Reset</button>` : ''}
        </div>`;
      }).join('');
    } else {
      cbStrip.innerHTML = '<div style="color:var(--t2);font-size:.8rem">All circuits healthy</div>';
    }

    // Alerts
    const abody = document.getElementById('alerts-tbody');
    alertCount = alerts.length;
    updateNavBadges();
    document.getElementById('alert-count').textContent = `${alerts.length} active`;

    if (alerts.length === 0) {
      abody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--t2);padding:24px">No active alerts</td></tr>';
    } else {
      abody.innerHTML = alerts.map(a => `<tr class="fade-in">
        <td>${a.level === 'error' ? statusBadge('fail') : a.level === 'warning' ? '<span class="badge b-warn"><span class="dot dot-warn"></span>warn</span>' : '<span class="badge b-dim"><span class="dot dot-dim"></span>info</span>'}</td>
        <td style="color:var(--t1)">${esc(a.message)}</td>
        <td>${fmtTime(a.timestamp)}</td>
        <td><button class="btn btn-sm" onclick="ackAlert(${a.id})">Ack</button></td>
      </tr>`).join('');
    }
  } catch (e) { console.error('loadHealth:', e); }
}

async function ackAlert(id) {
  await apiPost(`/api/alerts/${id}/acknowledge`);
  loadHealth();
}

async function resetBreaker(name) {
  await apiPost(`/api/breakers/${name}/reset`);
  loadHealth();
}

async function resetBreakers() {
  try {
    const breakers = await apiFetch('/api/breakers');
    for (const name of Object.keys(breakers)) {
      await apiPost(`/api/breakers/${name}/reset`);
    }
    loadHealth();
  } catch (e) { toast('Failed to reset breakers', true); }
}

async function pingAll() {
  try {
    const backends = ['claude-code', 'codex', 'api', 'local'];
    await Promise.allSettled(backends.map(b => apiPost(`/api/health/ping/${b}`)));
    toast('Pinged all backends');
  } catch (e) { toast('Ping failed', true); }
}

// â”€â”€â”€ PAGE 4: Plans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPendingPlans() {
  try {
    const data = await apiFetch('/api/plans/pending');
    const allPlans = { ...data.persistent, ...data.memory };
    const ids = Object.keys(allPlans);

    const container = document.getElementById('pending-plans');
    const list = document.getElementById('pending-list');

    if (ids.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    list.innerHTML = ids.map(id => {
      const p = allPlans[id];
      const plan = p.plan || p;
      return `<div class="dag-step" style="border-left-color:var(--info);margin-bottom:4px" onclick="viewPlan('${id}')">
        <div class="step-idx" style="background:rgba(59,130,246,.15);color:var(--info)">#</div>
        <div class="step-body">
          <div class="step-desc">${esc(plan.description || plan.task?.description || id)}</div>
          <div class="step-meta">${plan.steps ? plan.steps.length + ' steps' : ''} | ${id.substring(0, 8)}</div>
        </div>
        <div class="step-right">
          <button class="btn btn-sm btn-p" onclick="event.stopPropagation();quickApprove('${id}')">Approve</button>
          <button class="btn btn-sm btn-d" onclick="event.stopPropagation();quickCancel('${id}')">Cancel</button>
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.error('loadPendingPlans:', e); }
}

async function viewPlan(planId) {
  try {
    const data = await apiFetch(`/api/plan/${planId}`);
    renderPlan(data, planId);
  } catch (e) { toast('Could not load plan', true); }
}

async function quickApprove(planId) {
  currentPlanId = planId;
  await approvePlan();
  loadPendingPlans();
}

async function quickCancel(planId) {
  currentPlanId = planId;
  await cancelPlan();
  loadPendingPlans();
}

async function createPlan() {
  const desc = document.getElementById('plan-desc').value.trim();
  if (!desc) { toast('Enter a task description', true); return; }

  try {
    const data = await apiPost('/api/plan', {
      description: desc,
      type: document.getElementById('plan-type').value,
      complexity: parseInt(document.getElementById('plan-complexity')?.value || document.getElementById('plan-cpx').value) || 5
    });

    if (!data.plan) { toast('Plan creation failed', true); return; }
    renderPlan(data, data.plan.id);
  } catch (e) { toast('Plan failed: ' + e.message, true); }
}

function renderPlan(data, planId) {
  currentPlanId = planId;
  document.getElementById('plan-id').textContent = planId;
  document.getElementById('plan-result').style.display = 'block';

  const cost = data.costBreakdown || {};
  document.getElementById('plan-kpis').innerHTML = `
    <div class="kpi"><div class="kpi-label">Steps</div><div class="kpi-val v-blue">${cost.stepCount || (data.plan?.steps?.length || '?')}</div></div>
    <div class="kpi"><div class="kpi-label">API Cost</div><div class="kpi-val ${cost.needsApproval ? 'v-red' : 'v-green'}">${fmtCost(cost.totalApiCost || 0)}</div></div>
    <div class="kpi"><div class="kpi-label">Est. Time</div><div class="kpi-val v-yellow">~${cost.totalEstimatedMinutes || '?'}m</div></div>
    <div class="kpi"><div class="kpi-label">Approval</div><div class="kpi-val ${cost.needsApproval ? 'v-red' : 'v-green'}">${cost.needsApproval ? 'Required' : 'Auto'}</div></div>
  `;

  const plan = data.plan;
  const dag = document.getElementById('plan-dag');
  dag.innerHTML = (plan.steps || []).map((step, i) => {
    const backendClass = step.backend === 'claudeCode' || step.backend === 'claude-code' ? 'cc'
      : step.backend === 'codex' ? 'codex'
      : step.backend === 'api' ? 'api'
      : step.backend === 'local' ? 'local' : '';

    const depStr = step.dependencies?.length > 0
      ? `after ${step.dependencies.map(d => { const idx = plan.steps.findIndex(s => s.id === d); return idx >= 0 ? '#' + (idx + 1) : '?'; }).join(', ')}`
      : 'no deps';

    return `<div class="dag-step ${backendClass} fade-in" style="animation-delay:${i * 0.05}s">
      <div class="step-idx">${i + 1}</div>
      <div class="step-body">
        <div class="step-desc">${esc(step.description)}</div>
        <div class="step-meta">${step.backend} | ${step.critical ? 'critical' : 'optional'} | ${depStr}${step.parallelizable ? ' | parallel' : ''}</div>
      </div>
      <div class="step-right">
        ~${step.estimatedMinutes}m<br>
        ${fmtTokens(step.estimatedTokens)} tok<br>
        ${step.estimatedCost > 0 ? fmtCost(step.estimatedCost) : '$0'}
      </div>
    </div>`;
  }).join('');

  document.getElementById('plan-approve').disabled = false;
}

async function approvePlan() {
  if (!currentPlanId) return;
  try {
    const result = await apiPost(`/api/plan/${currentPlanId}/approve`);
    toast(result.success ? `Plan executed: ${result.completedSteps}/${result.totalSteps} steps` : 'Execution had failures');
    currentPlanId = null;
    document.getElementById('plan-approve').disabled = true;
  } catch (e) { toast('Execution failed', true); }
}

async function cancelPlan() {
  if (!currentPlanId) return;
  await apiPost(`/api/plan/${currentPlanId}/cancel`);
  currentPlanId = null;
  document.getElementById('plan-result').style.display = 'none';
}

// â”€â”€â”€ PAGE 5: History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  try {
    const from = document.getElementById('hist-from').value || '';
    const to = document.getElementById('hist-to').value || '';
    const backend = document.getElementById('hist-backend').value || '';
    const limit = document.getElementById('hist-limit').value || 100;

    let url = `/api/history?limit=${limit}`;
    if (from) url += `&from=${from}`;
    if (to) url += `&to=${to}`;
    if (backend) url += `&backend=${backend}`;

    const data = await apiFetch(url);
    historyData = data.items;

    document.getElementById('hist-count').textContent = `${data.items.length} results`;

    const tbody = document.getElementById('hist-tbody');
    if (data.items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--t2);padding:40px">No results found</td></tr>';
      document.getElementById('hist-mcards').innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">No results</div>';
      return;
    }

    tbody.innerHTML = data.items.map(h => {
      const cost = ['claudeCode', 'codex', 'local'].includes(h.backend) ? 0 : estimateApiCost(h.tokens || 0);
      return `<tr>
        <td>${fmtTimeFull(h.timestamp)}</td>
        <td>${h.success ? statusBadge('success') : statusBadge('fail')}</td>
        <td>${backendBadge(h.backend)}</td>
        <td>${h.taskType || '-'}</td>
        <td>${fmtDur(h.duration)}</td>
        <td>${fmtTokens(h.tokens)}</td>
        <td>${fmtCost(cost)}</td>
      </tr>`;
    }).join('');

    // Mobile cards
    document.getElementById('hist-mcards').innerHTML = data.items.map(h => {
      const cost = ['claudeCode', 'codex', 'local'].includes(h.backend) ? 0 : estimateApiCost(h.tokens || 0);
      return `<div class="m-card">
        <div class="m-card-row">
          ${h.success ? statusBadge('success') : statusBadge('fail')}
          ${backendBadge(h.backend)}
          <span class="m-card-meta">${fmtTime(h.timestamp)}</span>
        </div>
        <div class="m-card-row">
          <span class="m-card-meta">${h.taskType || '-'} &middot; ${fmtDur(h.duration)} &middot; ${fmtTokens(h.tokens)} tok &middot; ${fmtCost(cost)}</span>
        </div>
      </div>`;
    }).join('');
  } catch (e) { console.error('loadHistory:', e); }
}

function exportCSV() {
  if (!historyData.length) { toast('No data to export', true); return; }
  const header = 'timestamp,success,backend,taskType,duration_ms,tokens,est_cost_usd\n';
  const rows = historyData.map(h => {
    const cost = ['claudeCode', 'codex', 'local'].includes(h.backend) ? 0 : estimateApiCost(h.tokens || 0);
    return `${h.timestamp},${h.success},${h.backend},${h.taskType || ''},${h.duration},${h.tokens || 0},${cost.toFixed(4)}`;
  }).join('\n');
  const blob = new Blob([header + rows], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'task-history.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV downloaded');
}

// â”€â”€â”€ PAGE 6: Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadConfig() {
  try {
    const config = await apiFetch('/api/config');
    const pretty = JSON.stringify(config, null, 2);
    document.getElementById('cfg-edit').value = pretty;
    document.getElementById('cfg-ro').textContent = pretty;
  } catch (e) { console.error('loadConfig:', e); }
}

async function saveConfig() {
  try {
    const raw = document.getElementById('cfg-edit').value;
    const parsed = JSON.parse(raw);
    const result = await apiPut('/api/config', parsed);
    toast(result.message || 'Config saved');
    loadConfig();
  } catch (e) {
    if (e instanceof SyntaxError) toast('Invalid JSON', true);
    else toast('Save failed: ' + e.message, true);
  }
}

// â”€â”€â”€ Nav Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateNavBadges() {
  const healthBtn = document.querySelector('.nav button[data-page="health"]');
  if (healthBtn) {
    const existing = healthBtn.querySelector('.badge-count');
    if (existing) existing.remove();
    if (alertCount > 0) {
      healthBtn.innerHTML = 'Health<span class="badge-count">' + alertCount + '</span>';
    } else {
      healthBtn.textContent = 'Health';
    }
  }
}

// â”€â”€â”€ Command Palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const commands = [
  { label: 'Go to Queue', key: '1', action: () => switchPage('queue') },
  { label: 'Go to Costs', key: '2', action: () => switchPage('costs') },
  { label: 'Go to Health', key: '3', action: () => switchPage('health') },
  { label: 'Go to Plans', key: '4', action: () => switchPage('plans') },
  { label: 'Go to History', key: '5', action: () => switchPage('history') },
  { label: 'Go to Settings', key: '6', action: () => switchPage('settings') },
  { label: 'Go to Benchmarks', key: '7', action: () => switchPage('benchmarks') },
  { label: 'Refresh Current View', key: 'R', action: () => refreshPage() },
  { label: 'Pause Scheduler', action: () => apiPost('/api/scheduler/pause') },
  { label: 'Resume Scheduler', action: () => apiPost('/api/scheduler/resume') },
  { label: 'Ping All Backends', action: () => pingAll() },
  { label: 'Export History CSV', action: () => exportCSV() },
];

let cmdSelected = 0;
let cmdFiltered = [...commands];

function openCmd() {
  const overlay = document.getElementById('cmd-overlay');
  const input = document.getElementById('cmd-input');
  overlay.classList.add('open');
  input.value = '';
  input.focus();
  cmdSelected = 0;
  renderCmdList('');
}

function closeCmd() {
  document.getElementById('cmd-overlay').classList.remove('open');
}

function renderCmdList(query) {
  const q = query.toLowerCase();
  cmdFiltered = commands.filter(c => c.label.toLowerCase().includes(q));
  cmdSelected = Math.min(cmdSelected, Math.max(0, cmdFiltered.length - 1));
  const list = document.getElementById('cmd-list');
  list.innerHTML = cmdFiltered.map((c, i) =>
    `<div class="cmd-item${i === cmdSelected ? ' selected' : ''}" onmouseenter="cmdSelected=${i};renderCmdList(document.getElementById('cmd-input').value)" onclick="runCmd(${i})">
      ${c.label}
      ${c.key ? `<span class="cmd-key">${c.key}</span>` : ''}
    </div>`
  ).join('') || '<div style="padding:14px;color:var(--t2);text-align:center;font-size:.82rem">No commands found</div>';
}

function runCmd(idx) {
  if (cmdFiltered[idx]) {
    cmdFiltered[idx].action();
    closeCmd();
  }
}

document.getElementById('cmd-input').addEventListener('input', e => {
  renderCmdList(e.target.value);
});

document.getElementById('cmd-input').addEventListener('keydown', e => {
  if (e.key === 'ArrowDown') { e.preventDefault(); cmdSelected = Math.min(cmdSelected + 1, cmdFiltered.length - 1); renderCmdList(e.target.value); }
  if (e.key === 'ArrowUp') { e.preventDefault(); cmdSelected = Math.max(cmdSelected - 1, 0); renderCmdList(e.target.value); }
  if (e.key === 'Enter') { e.preventDefault(); runCmd(cmdSelected); }
  if (e.key === 'Escape') { e.preventDefault(); closeCmd(); }
});

document.getElementById('cmd-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeCmd();
});

// â”€â”€â”€ Keyboard Shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  // Skip if typing in an input
  const tag = e.target.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    openCmd();
    return;
  }

  if (e.key === 'Escape') {
    closeCmd();
    return;
  }

  if (e.key >= '1' && e.key <= '7') {
    const pages = ['queue', 'costs', 'health', 'plans', 'history', 'settings', 'benchmarks'];
    switchPage(pages[parseInt(e.key) - 1]);
    return;
  }

  if (e.key === 'r' || e.key === 'R') {
    refreshPage();
    toast('Refreshed');
    return;
  }

  if (e.key === '?') {
    const help = document.getElementById('kb-help');
    help.style.display = help.style.display === 'none' ? '' : 'none';
  }
});

// â”€â”€â”€ PAGE 7: Benchmarks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBenchmarks() {
  try {
    const [trust, results, insights] = await Promise.all([
      apiFetch('/api/shadow/trust'),
      apiFetch('/api/shadow/results?limit=50'),
      apiFetch('/api/shadow/insights')
    ]);

    loadTrustMatrix(trust.trust);
    loadRecentComparisons(results.results);
    loadInsights(insights.insights);
    loadFeedbackQueue(results.results);
  } catch (e) { console.error('loadBenchmarks:', e); }
}

function loadTrustMatrix(trustData) {
  const container = document.getElementById('trust-matrix');
  
  // Get all unique task types and models
  const taskTypes = [...new Set(Object.keys(trustData))].sort();
  const models = [...new Set(Object.values(trustData).flatMap(t => Object.keys(t)))].sort();
  
  if (taskTypes.length === 0 || models.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">No trust data available</div>';
    return;
  }
  
  let html = '<div class="trust-matrix"><table><thead><tr><th>Task Type</th>';
  models.forEach(model => {
    html += `<th>${model.replace('claude-', '').replace('-code', '').replace('codex', 'Codex').replace('local', 'Local')}</th>`;
  });
  html += '</tr></thead><tbody>';
  
  taskTypes.forEach(taskType => {
    html += `<tr><th>${taskType}</th>`;
    models.forEach(model => {
      const trust = trustData[taskType]?.[model];
      let cellClass = 'trust-none';
      let score = '-';
      
      if (trust && trust.samples >= 3) {
        if (trust.score >= 0.85) {
          cellClass = 'trust-good';
          score = (trust.score * 100).toFixed(0) + '%';
        } else if (trust.score >= 0.5) {
          cellClass = 'trust-promising';
          score = (trust.score * 100).toFixed(0) + '%';
        } else {
          cellClass = 'trust-bad';
          score = (trust.score * 100).toFixed(0) + '%';
        }
      }
      
      html += `<td><div class="trust-cell ${cellClass}" title="${trust ? `${trust.samples} samples` : 'No data'}">${score}</div></td>`;
    });
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function loadRecentComparisons(results) {
  const tbody = document.getElementById('comparison-tbody');
  const mcards = document.getElementById('comparison-mcards');
  
  document.getElementById('comparison-count').textContent = `${results.length} results`;
  
  if (results.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--t2);padding:40px">No comparisons available</td></tr>';
    mcards.innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">No comparisons</div>';
    return;
  }
  
  // Desktop table
  tbody.innerHTML = results.slice(0, 20).map((result, idx) => `
    <tr class="expandable-row fade-in" onclick="toggleExpansion('exp-${idx}')">
      <td>${result.task_type}</td>
      <td>${result.shadow_model.replace('claude-', '').replace('-code', '')}</td>
      <td><span class="badge ${getScoreBadge(result.auto_score)}">${result.auto_score ? (result.auto_score * 100).toFixed(0) + '%' : '-'}</span></td>
      <td>${fmtTime(result.timestamp)}</td>
      <td><button class="btn btn-sm" onclick="event.stopPropagation();showFeedback('${result.id}')">Review</button></td>
    </tr>
    <tr class="expansion" id="exp-${idx}">
      <td colspan="5">
        <div class="expansion-content">
          <div><strong>${esc(result.description)}</strong></div>
          <div class="output-comparison">
            <div class="output-section">
              <div class="output-header">Primary (${result.primary_model})</div>
              <div class="output-text">${esc(result.primary_output || 'No output')}</div>
            </div>
            <div class="output-section">
              <div class="output-header">Shadow (${result.shadow_model})</div>
              <div class="output-text">${esc(result.shadow_output || 'No output')}</div>
            </div>
          </div>
          <div style="margin-top:8px;font-size:.68rem;color:var(--t2);font-family:var(--mono)">
            Length: ${result.length_similarity ? (result.length_similarity * 100).toFixed(0) + '%' : '-'} | 
            Structure: ${result.structure_similarity ? (result.structure_similarity * 100).toFixed(0) + '%' : '-'} | 
            Key Terms: ${result.key_term_overlap ? (result.key_term_overlap * 100).toFixed(0) + '%' : '-'}
          </div>
        </div>
      </td>
    </tr>
  `).join('');
  
  // Mobile cards
  mcards.innerHTML = results.slice(0, 10).map(result => `
    <div class="m-card fade-in">
      <div class="m-card-row">
        <span class="m-card-title">${result.task_type}</span>
        <span class="badge ${getScoreBadge(result.auto_score)}">${result.auto_score ? (result.auto_score * 100).toFixed(0) + '%' : '-'}</span>
      </div>
      <div class="m-card-row">
        <span class="m-card-meta">${result.shadow_model.replace('claude-', '').replace('-code', '')} â€¢ ${fmtTime(result.timestamp)}</span>
      </div>
      <div class="m-card-actions">
        <button class="btn btn-sm" onclick="showFeedback('${result.id}')">Review</button>
      </div>
    </div>
  `).join('');
}

function getScoreBadge(score) {
  if (!score) return 'b-dim';
  if (score >= 0.85) return 'b-ok';
  if (score >= 0.5) return 'b-warn';
  return 'b-err';
}

function loadInsights(insights) {
  const container = document.getElementById('insights-container');
  
  if (insights.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">No insights available</div>';
    return;
  }
  
  container.innerHTML = insights.map(insight => `
    <div class="insight-card ${insight.type} fade-in">
      <div class="insight-title">${insight.type === 'trust' ? 'ğŸ¯ Trust Insight' : insight.type === 'local' ? 'ğŸ’» Local Model' : 'ğŸ’° Savings'}</div>
      <div class="insight-message">${esc(insight.message)}</div>
      <div class="insight-meta">
        ${insight.score ? `Score: ${(insight.score * 100).toFixed(0)}%` : ''} 
        ${insight.samples ? `â€¢ ${insight.samples} samples` : ''}
      </div>
    </div>
  `).join('');
}

function loadFeedbackQueue(results) {
  const container = document.getElementById('feedback-queue');
  
  // Filter results that need feedback (no user_score and auto_score exists)
  const needsFeedback = results.filter(r => !r.user_score && r.auto_score !== null);
  
  document.getElementById('feedback-count').textContent = `${needsFeedback.length} pending`;
  
  if (needsFeedback.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--t2);padding:40px">No feedback needed</div>';
    return;
  }
  
  container.innerHTML = needsFeedback.slice(0, 5).map(result => `
    <div class="feedback-item fade-in">
      <div class="feedback-header">
        <div class="feedback-task">${esc(result.description.substring(0, 60))}${result.description.length > 60 ? '...' : ''}</div>
        <div class="feedback-score badge ${getScoreBadge(result.auto_score)}">Auto: ${(result.auto_score * 100).toFixed(0)}%</div>
      </div>
      <div class="feedback-outputs">
        <div class="feedback-output">
          <div class="feedback-output-title">Primary (${result.primary_model})</div>
          <div class="feedback-output-text">${esc(result.primary_output || 'No output')}</div>
        </div>
        <div class="feedback-output">
          <div class="feedback-output-title">Shadow (${result.shadow_model})</div>
          <div class="feedback-output-text">${esc(result.shadow_output || 'No output')}</div>
        </div>
      </div>
      <div class="feedback-actions">
        <button class="feedback-btn good" onclick="submitFeedback('${result.id}', 1)">
          <span>ğŸ‘</span> Good
        </button>
        <button class="feedback-btn bad" onclick="submitFeedback('${result.id}', 0)">
          <span>ğŸ‘</span> Poor
        </button>
      </div>
    </div>
  `).join('');
}

function toggleExpansion(id) {
  const expansion = document.getElementById(id);
  expansion.classList.toggle('open');
}

function showFeedback(shadowId) {
  // This would show a modal or detailed feedback form
  // For now, just focus on the feedback queue
  switchPage('benchmarks');
  const feedbackQueue = document.getElementById('feedback-queue');
  feedbackQueue.scrollIntoView({ behavior: 'smooth' });
}

async function submitFeedback(shadowId, score) {
  try {
    await apiPost(`/api/shadow/${shadowId}/feedback`, { score, comment: null });
    toast('Feedback submitted');
    loadBenchmarks(); // Refresh the view
  } catch (e) {
    toast('Failed to submit feedback', true);
  }
}

// â”€â”€â”€ Escape HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = String(str).substring(0, 200);
  return d.innerHTML;
}

// â”€â”€â”€ Auto-refresh Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  if (activePage === 'queue') loadQueue();
  if (activePage === 'health') loadHealth();
}, 30000);

// Cost charts refresh less frequently
setInterval(() => {
  if (activePage === 'costs') loadCosts();
}, 60000);

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  connectSSE();
  loadQueue();

  // Set default date range for history
  const now = new Date();
  const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
  document.getElementById('hist-from').value = weekAgo.toISOString().slice(0, 10);
  document.getElementById('hist-to').value = now.toISOString().slice(0, 10);
});
</script>
</body>
</html>
